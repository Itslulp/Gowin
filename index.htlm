import { useEffect, useMemo, useRef, useState, useCallback } from "react";

// --- Ø§Ù„ØªØ¹Ø±ÙŠÙØ§Øª ÙˆØ§Ù„Ø£Ù†ÙˆØ§Ø¹ (Types) ---
type Question = {
  emoji: string;
  question: string;
  options: string[];
  answer: string;
};

type LeaderboardEntry = {
  name: string;
  time: number;
  lives: number;
  timestamp: number;
};

type GoatRecord = {
  name: string;
  time: number;
  lives: number;
  timestamp: number;
};

type Match = {
  player1: string;
  player2: string;
  winner?: string;
  player1Lives?: number;
  player2Lives?: number;
  player1Time?: number;
  player2Time?: number;
};

type TournamentRound = {
  roundNumber: number;
  matches: Match[];
  questions: Question[];
};

type MultiplayerRoom = {
  roomId: string;
  mode: "cooperative" | "versus";
  player1: string;
  player2?: string;
  player1Ready: boolean;
  player2Ready: boolean;
  status: "waiting" | "playing" | "finished";
};

// --- Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ---
const allQuestionsAr: Question[][] = [
  [
    { emoji: "ğŸŒ", question: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© ÙØ±Ù†Ø³Ø§ØŸ", options: ["Ø¨Ø§Ø±ÙŠØ³", "Ù…Ø¯Ø±ÙŠØ¯", "Ø±ÙˆÙ…Ø§", "Ø¨Ø±Ù„ÙŠÙ†"], answer: "Ø¨Ø§Ø±ÙŠØ³" },
    { emoji: "ğŸ§®", question: "ÙƒÙ… Ø§Ù„Ù†Ø§ØªØ¬ØŸ 12 Ã— 8", options: ["92", "96", "88", "108"], answer: "96" },
    { emoji: "ğŸª", question: "Ø£ÙƒØ¨Ø± ÙƒÙˆÙƒØ¨ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø´Ù…Ø³ÙŠØ©ØŸ", options: ["Ø§Ù„Ø£Ø±Ø¶", "Ø§Ù„Ù…Ø´ØªØ±ÙŠ", "Ø§Ù„Ù…Ø±ÙŠØ®", "Ø²Ø­Ù„"], answer: "Ø§Ù„Ù…Ø´ØªØ±ÙŠ" },
    { emoji: "ğŸ’»", question: "Ù…Ø¤Ø³Ø³ Ø´Ø±ÙƒØ© Ù…Ø§ÙŠÙƒØ±ÙˆØ³ÙˆÙØªØŸ", options: ["Ø³ØªÙŠÙ Ø¬ÙˆØ¨Ø²", "Ø¥ÙŠÙ„ÙˆÙ† Ù…Ø§Ø³Ùƒ", "Ø¨ÙŠÙ„ ØºÙŠØªØ³", "Ù…Ø§Ø±Ùƒ Ø²ÙˆÙƒØ±Ø¨ÙŠØ±Øº"], answer: "Ø¨ÙŠÙ„ ØºÙŠØªØ³" },
  ],
];

const TOTAL_LIVES = 5;

export const App = () => {
  const [playerName, setPlayerName] = useState("");
  const [playerInput, setPlayerInput] = useState("");
  const [current, setCurrent] = useState(0);
  const [lives, setLives] = useState(TOTAL_LIVES);
  const [shake, setShake] = useState(false);
  const [elapsed, setElapsed] = useState(0);
  const [status, setStatus] = useState<"playing" | "won" | "lost">("playing");
  const [language, setLanguage] = useState<"ar" | "en">("ar");
  
  // --- Ù…Ø´ØºÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ© (MP3 Ø®Ø§Ø±Ø¬ÙŠ) ---
  const audioRef = useRef<HTMLAudioElement | null>(null);

  const startBackgroundMusic = () => {
    if (!audioRef.current) {
      // ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø±Ø§Ø¨Ø· Ù…ÙˆØ³ÙŠÙ‚Ù‰ MP3 Ù…Ø¨Ø§Ø´Ø± ÙˆØ­Ù…Ø§Ø³ÙŠ
      audioRef.current = new Audio("https://www.soundhelix.com/examples/mp3/SoundHelix-Song-8.mp3");
      audioRef.current.loop = true; // ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰
      audioRef.current.volume = 0.3; // Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª (Ù‡Ø§Ø¯Ø¦ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©)
    }
    audioRef.current.play().catch(err => console.log("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", err));
  };

  const handleStart = () => {
    if (!playerInput.trim()) return;
    
    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ ÙÙˆØ± Ø§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ø²Ø±
    startBackgroundMusic();
    
    setPlayerName(playerInput.trim());
    localStorage.setItem("player-name", playerInput.trim());
  };

  useEffect(() => {
    let timer: number;
    if (playerName && status === "playing") {
      timer = window.setInterval(() => setElapsed(prev => prev + 1), 1000);
    }
    return () => clearInterval(timer);
  }, [playerName, status]);

  const questions = allQuestionsAr[0];
  const question = questions[current];
  const progress = ((current + 1) / questions.length) * 100;

  const handleAnswer = (option: string) => {
    if (status !== "playing") return;
    if (option === question.answer) {
      if (current === questions.length - 1) {
        setStatus("won");
      } else {
        setCurrent(prev => prev + 1);
      }
    } else {
      setShake(true);
      setLives(prev => {
        const newLives = prev - 1;
        if (newLives <= 0) setStatus("lost");
        return newLives;
      });
      setTimeout(() => setShake(false), 500);
    }
  };

  return (
    <div className="min-h-screen bg-animated-gradient text-white font-sans selection:bg-cyan-500/30">
      <div className="mx-auto flex min-h-screen max-w-6xl flex-col gap-10 px-6 py-10">
        
        {/* Ø§Ù„Ù‡ÙŠØ¯Ø± */}
        <header className="flex flex-wrap items-center justify-between gap-6">
          <h1 className="text-4xl md:text-5xl font-black bg-gradient-to-r from-yellow-200 to-orange-400 bg-clip-text text-transparent">
            Ø¯ÙˆØ±ÙŠ Ø£Ø¨Ø·Ø§Ù„ Gowin
          </h1>
          <div className="flex gap-6">
            <div className="text-right">
              <p className="text-sm text-white/70">Ø§Ù„ÙˆÙ‚Øª</p>
              <p className="text-2xl font-bold">{elapsed}s</p>
            </div>
            <div>
              <p className="text-sm text-white/70">Ø§Ù„Ø­ÙŠÙˆØ§Øª</p>
              <div className="flex gap-1">
                {Array.from({ length: TOTAL_LIVES }).map((_, i) => (
                  <span key={i} className={i < lives ? "text-xl" : "text-xl opacity-20"}>â¤ï¸</span>
                ))}
              </div>
            </div>
          </div>
        </header>

        <main className="grid gap-8 lg:grid-cols-[1.1fr_0.9fr]">
          <section className={`relative rounded-3xl border border-white/15 bg-white/10 p-8 shadow-xl backdrop-blur transition-all ${shake ? "card-shake" : ""}`}>
            {status === "playing" ? (
              <>
                <div className="mb-6 h-2 w-full rounded-full bg-white/10">
                  <div className="h-full rounded-full bg-gradient-to-r from-cyan-400 to-blue-500 transition-all duration-500" style={{ width: `${progress}%` }} />
                </div>
                <h2 className="text-3xl font-bold mb-8">{question.emoji} {question.question}</h2>
                <div className="grid gap-4">
                  {question.options.map(opt => (
                    <button key={opt} onClick={() => handleAnswer(opt)} className="w-full rounded-2xl border border-white/10 bg-white/5 p-4 text-right text-lg transition hover:bg-white/20 hover:scale-[1.02]">
                      {opt}
                    </button>
                  ))}
                </div>
              </>
            ) : (
              <div className="py-20 text-center">
                <h2 className="text-4xl font-black mb-4">{status === "won" ? "ğŸ† Ø¨Ø·Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„!" : "ğŸ’€ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬ÙŠØ¯Ø©.."}</h2>
                <button onClick={() => window.location.reload()} className="rounded-xl bg-white px-8 py-3 font-bold text-slate-900 shadow-lg hover:bg-yellow-400 transition">
                  Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                </button>
              </div>
            )}
          </section>

          <section className="rounded-3xl border border-white/15 bg-white/10 p-6 shadow-xl backdrop-blur min-h-[300px]">
             <h3 className="text-xl font-bold mb-4">ğŸ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h3>
             <p className="text-white/40 text-center mt-10 italic">Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù†ØªÙŠØ¬ØªÙƒ ÙÙˆØ± Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡...</p>
          </section>
        </main>
      </div>

      {/* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ù„Ø²Ø§Ù…ÙŠØ© Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª */}
      {!playerName && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/90 backdrop-blur-md p-6">
          <div className="w-full max-w-lg rounded-3xl border border-white/20 bg-slate-900 p-8 shadow-2xl text-center">
            <h2 className="text-3xl font-black text-white mb-6">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Gowin</h2>
            <input 
              value={playerInput} 
              onChange={(e) => setPlayerInput(e.target.value)} 
              placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." 
              className="w-full rounded-2xl bg-white/10 p-4 text-center text-white border border-white/20 focus:outline-none mb-6 text-xl"
            />
            <button 
              onClick={handleStart} 
              className="w-full rounded-2xl bg-gradient-to-r from-yellow-400 to-orange-500 p-5 font-bold text-slate-900 text-2xl shadow-xl hover:scale-105 active:scale-95 transition-all"
            >
              ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨
            </button>
            <p className="text-white/40 mt-4 text-sm">Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ø¨Ø¯Ø£ØŒ Ø³ØªØ¹Ù…Ù„ Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ©</p>
          </div>
        </div>
      )}
    </div>
  );
};

export default App;
