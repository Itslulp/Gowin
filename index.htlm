import { useEffect, useMemo, useRef, useState, useCallback } from "react";

type Question = {
  emoji: string;
  question: string;
  options: string[];
  answer: string;
};

type LeaderboardEntry = {
  name: string;
  time: number;
  lives: number;
  timestamp: number;
};

type GoatRecord = {
  name: string;
  time: number;
  lives: number;
  timestamp: number;
};

const isBetterRecord = (candidate: GoatRecord, current: GoatRecord | null) => {
  if (!current) return true;
  if (candidate.lives !== current.lives) return candidate.lives > current.lives;
  return candidate.time < current.time;
};

type Match = {
  player1: string;
  player2: string;
  winner?: string;
  player1Lives?: number;
  player2Lives?: number;
  player1Time?: number;
  player2Time?: number;
};

type TournamentRound = {
  roundNumber: number;
  matches: Match[];
  questions: Question[];
};

type ChatMessage = {
  sender: string;
  message: string;
  timestamp: number;
};

type MultiplayerRoom = {
  roomId: string;
  mode: "cooperative" | "versus";
  player1: string;
  player2?: string;
  player1Ready: boolean;
  player2Ready: boolean;
  chat: ChatMessage[];
  currentQuestion: number;
  player1Lives: number;
  player2Lives: number;
  player1Time: number;
  player2Time: number;
  startTime?: number;
  status: "waiting" | "playing" | "finished";
  winner?: string;
};

const allQuestionsAr: Question[][] = [
  [
    { emoji: "ğŸŒ", question: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© ÙØ±Ù†Ø³Ø§ØŸ", options: ["Ø¨Ø§Ø±ÙŠØ³", "Ù…Ø¯Ø±ÙŠØ¯", "Ø±ÙˆÙ…Ø§", "Ø¨Ø±Ù„ÙŠÙ†"], answer: "Ø¨Ø§Ø±ÙŠØ³" },
    { emoji: "ğŸ§®", question: "ÙƒÙ… Ø§Ù„Ù†Ø§ØªØ¬ØŸ 12 Ã— 8", options: ["92", "96", "88", "108"], answer: "96" },
    { emoji: "ğŸª", question: "Ø£ÙƒØ¨Ø± ÙƒÙˆÙƒØ¨ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø´Ù…Ø³ÙŠØ©ØŸ", options: ["Ø§Ù„Ø£Ø±Ø¶", "Ø§Ù„Ù…Ø´ØªØ±ÙŠ", "Ø§Ù„Ù…Ø±ÙŠØ®", "Ø²Ø­Ù„"], answer: "Ø§Ù„Ù…Ø´ØªØ±ÙŠ" },
    { emoji: "ğŸ’»", question: "Ù…Ø¤Ø³Ø³ Ø´Ø±ÙƒØ© Ù…Ø§ÙŠÙƒØ±ÙˆØ³ÙˆÙØªØŸ", options: ["Ø³ØªÙŠÙ Ø¬ÙˆØ¨Ø²", "Ø¥ÙŠÙ„ÙˆÙ† Ù…Ø§Ø³Ùƒ", "Ø¨ÙŠÙ„ ØºÙŠØªØ³", "Ù…Ø§Ø±Ùƒ Ø²ÙˆÙƒØ±Ø¨ÙŠØ±Øº"], answer: "Ø¨ÙŠÙ„ ØºÙŠØªØ³" },
  ],
  [
    { emoji: "ğŸ”ï¸", question: "Ø£Ø¹Ù„Ù‰ Ø¬Ø¨Ù„ ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù…ØŸ", options: ["ÙƒÙ„ÙŠÙ…Ù†Ø¬Ø§Ø±Ùˆ", "Ø¥ÙŠÙØ±Ø³Øª", "Ø§Ù„Ø£Ù„Ø¨", "Ø§Ù„Ø£Ù†Ø¯ÙŠØ²"], answer: "Ø¥ÙŠÙØ±Ø³Øª" },
    { emoji: "ğŸ”¢", question: "ÙƒÙ… Ø§Ù„Ù†Ø§ØªØ¬ØŸ 15 Ã— 7", options: ["95", "100", "105", "110"], answer: "105" },
    { emoji: "ğŸŒŠ", question: "Ø£ÙƒØ¨Ø± Ù…Ø­ÙŠØ· ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù…ØŸ", options: ["Ø§Ù„Ø£Ø·Ù„Ø³ÙŠ", "Ø§Ù„Ù‡Ù†Ø¯ÙŠ", "Ø§Ù„Ù‡Ø§Ø¯Ø¦", "Ø§Ù„Ù…ØªØ¬Ù…Ø¯"], answer: "Ø§Ù„Ù‡Ø§Ø¯Ø¦" },
    { emoji: "ğŸ¨", question: "Ø±Ø³Ø§Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆÙ†Ø§Ù„ÙŠØ²Ø§ØŸ", options: ["Ø¨ÙŠÙƒØ§Ø³Ùˆ", "Ø¯Ø§ÙÙ†Ø´ÙŠ", "ÙØ§Ù† Ø¬ÙˆØ®", "Ù…ÙˆÙ†ÙŠÙ‡"], answer: "Ø¯Ø§ÙÙ†Ø´ÙŠ" },
  ],
  [
    { emoji: "âš½", question: "Ø£ÙƒØ«Ø± Ø¯ÙˆÙ„Ø© ÙØ§Ø²Øª Ø¨ÙƒØ£Ø³ Ø§Ù„Ø¹Ø§Ù„Ù…ØŸ", options: ["Ø§Ù„Ø¨Ø±Ø§Ø²ÙŠÙ„", "Ø£Ù„Ù…Ø§Ù†ÙŠØ§", "Ø§Ù„Ø£Ø±Ø¬Ù†ØªÙŠÙ†", "Ø¥ÙŠØ·Ø§Ù„ÙŠØ§"], answer: "Ø§Ù„Ø¨Ø±Ø§Ø²ÙŠÙ„" },
    { emoji: "ğŸ§ª", question: "Ø§Ù„Ø±Ù…Ø² Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠ Ù„Ù„Ø°Ù‡Ø¨ØŸ", options: ["Go", "Gd", "Au", "Ag"], answer: "Au" },
    { emoji: "ğŸ“…", question: "Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ù†Ø© Ø§Ù„ÙƒØ¨ÙŠØ³Ø©ØŸ", options: ["365", "366", "364", "367"], answer: "366" },
    { emoji: "ğŸŒ¡ï¸", question: "Ø¯Ø±Ø¬Ø© ØºÙ„ÙŠØ§Ù† Ø§Ù„Ù…Ø§Ø¡ØŸ", options: ["90Â°", "100Â°", "110Â°", "120Â°"], answer: "100Â°" },
  ],
];

const allQuestionsEn: Question[][] = [
  [
    { emoji: "ğŸŒ", question: "What is the capital of France?", options: ["Paris", "Madrid", "Rome", "Berlin"], answer: "Paris" },
    { emoji: "ğŸ§®", question: "What is 12 Ã— 8?", options: ["92", "96", "88", "108"], answer: "96" },
    { emoji: "ğŸª", question: "The largest planet in our solar system?", options: ["Earth", "Jupiter", "Mars", "Saturn"], answer: "Jupiter" },
    { emoji: "ğŸ’»", question: "Founder of Microsoft?", options: ["Steve Jobs", "Elon Musk", "Bill Gates", "Mark Zuckerberg"], answer: "Bill Gates" },
  ],
  [
    { emoji: "ğŸ”ï¸", question: "The highest mountain in the world?", options: ["Kilimanjaro", "Everest", "The Alps", "The Andes"], answer: "Everest" },
    { emoji: "ğŸ”¢", question: "What is 15 Ã— 7?", options: ["95", "100", "105", "110"], answer: "105" },
    { emoji: "ğŸŒŠ", question: "The largest ocean in the world?", options: ["Atlantic", "Indian", "Pacific", "Arctic"], answer: "Pacific" },
    { emoji: "ğŸ¨", question: "Who painted the Mona Lisa?", options: ["Picasso", "Da Vinci", "Van Gogh", "Monet"], answer: "Da Vinci" },
  ],
  [
    { emoji: "âš½", question: "Which country won the most FIFA World Cups?", options: ["Brazil", "Germany", "Argentina", "Italy"], answer: "Brazil" },
    { emoji: "ğŸ§ª", question: "The chemical symbol for gold?", options: ["Go", "Gd", "Au", "Ag"], answer: "Au" },
    { emoji: "ğŸ“…", question: "How many days in a leap year?", options: ["365", "366", "364", "367"], answer: "366" },
    { emoji: "ğŸŒ¡ï¸", question: "Boiling point of water?", options: ["90Â°", "100Â°", "110Â°", "120Â°"], answer: "100Â°" },
  ],
];

const TOTAL_LIVES = 5;
const PLAYER_KEY = "player-name";
const LEADERBOARD_KEY = "gowin-leaderboard";
const TOURNAMENT_KEY = "gowin-tournament";
const GOAT_KEY = "gowin-goat-record";
const MULTIPLAYER_ROOMS_KEY = "gowin-multiplayer-rooms";

const getRankTitle = (rank: number): { title: string; emoji: string; color: string } => {
  if (rank === 1) return { title: "Ø£Ø³Ø·ÙˆØ±Ø©", emoji: "ğŸ‘‘", color: "from-yellow-400 to-orange-500" };
  if (rank === 2) return { title: "Ø¹Ø¨Ù‚Ø±ÙŠ", emoji: "ğŸ§ ", color: "from-purple-400 to-pink-500" };
  if (rank === 3) return { title: "Ø°ÙŠØ¨", emoji: "ğŸº", color: "from-blue-400 to-cyan-500" };
  if (rank <= 5) return { title: "Ù…Ø­ØªØ±Ù", emoji: "â­", color: "from-green-400 to-emerald-500" };
  if (rank <= 8) return { title: "Ù…ØªÙ‚Ø¯Ù…", emoji: "ğŸ¯", color: "from-indigo-400 to-blue-500" };
  if (rank <= 12) return { title: "Ù†Ø¬Ù…", emoji: "âœ¨", color: "from-pink-400 to-rose-500" };
  if (rank <= 16) return { title: "ØµØ§Ø¹Ø¯", emoji: "ğŸš€", color: "from-cyan-400 to-teal-500" };
  return { title: "Ù…Ø¨ØªØ¯Ø¦", emoji: "ğŸ”¥", color: "from-gray-400 to-slate-500" };
};

const useAudio = () => {
  const audioRef = useRef<HTMLAudioElement | null>(null);

  useEffect(() => {
    if (typeof window !== "undefined") {
      audioRef.current = new Audio();
    }
    return () => {
      if (audioRef.current) {
        audioRef.current.pause();
        audioRef.current = null;
      }
    };
  }, []);

  const playSound = (frequency: number, duration: number = 0.5, volume: number = 0.5) => {
    try {
      const ctx = new AudioContext();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      
      osc.type = "sine";
      osc.frequency.value = frequency;
      
      gain.gain.setValueAtTime(0, ctx.currentTime);
      gain.gain.linearRampToValueAtTime(volume, ctx.currentTime + 0.05);
      gain.gain.linearRampToValueAtTime(0, ctx.currentTime + duration);
      
      osc.connect(gain);
      gain.connect(ctx.destination);
      
      osc.start();
      osc.stop(ctx.currentTime + duration);
      
      setTimeout(() => ctx.close(), (duration + 0.1) * 1000);
    } catch (e) {}
  };

  const playCorrect = () => {
    playSound(523.25, 0.3, 0.3);
    setTimeout(() => playSound(659.25, 0.3, 0.3), 100);
    setTimeout(() => playSound(783.99, 0.4, 0.3), 200);
  };

  const playWrong = () => {
    playSound(196.00, 0.5, 0.3);
  };

  const playFanfare = () => {
    const notes = [523.25, 659.25, 783.99, 1046.50];
    notes.forEach((note, i) => {
      setTimeout(() => playSound(note, 0.6, 0.4), i * 150);
    });
  };

  const playExciting = () => {
    playSound(392.00, 0.3, 0.3);
    setTimeout(() => playSound(493.88, 0.3, 0.3), 50);
    setTimeout(() => playSound(587.33, 0.4, 0.3), 100);
  };

  const playStart = () => {
    playSound(523.25, 0.5, 0.4);
    setTimeout(() => playSound(659.25, 0.5, 0.4), 150);
    setTimeout(() => playSound(783.99, 0.6, 0.4), 300);
  };

  const playQuestionSound = () => {
    playSound(440, 0.2, 0.25);
    setTimeout(() => playSound(554.37, 0.2, 0.25), 100);
  };

  const playLoseLife = () => {
    playSound(329.63, 0.4, 0.3);
    setTimeout(() => playSound(293.66, 0.5, 0.25), 150);
    setTimeout(() => playSound(261.63, 0.6, 0.2), 300);
  };

  const playVictoryMusic = () => {
    const melody = [523.25, 659.25, 783.99, 1046.50, 783.99, 1046.50];
    melody.forEach((note, i) => {
      setTimeout(() => playSound(note, 0.5, 0.4), i * 200);
    });
  };

  const playClick = () => {
    playSound(800, 0.08, 0.2);
  };

  return { 
    playCorrect, 
    playWrong, 
    playFanfare, 
    playExciting, 
    playStart,
    playQuestionSound,
    playLoseLife,
    playVictoryMusic,
    playClick
  };
};

export function App() {
  const [playerName, setPlayerName] = useState("");
  const [playerInput, setPlayerInput] = useState("");
  const [current, setCurrent] = useState(0);
  const [lives, setLives] = useState(TOTAL_LIVES);
  const [shake, setShake] = useState(false);
  const [elapsed, setElapsed] = useState(0);
  const [status, setStatus] = useState<"playing" | "won" | "lost">("playing");
  const [leaderboard, setLeaderboard] = useState<LeaderboardEntry[]>([]);
  const [goatRecord, setGoatRecord] = useState<GoatRecord | null>(null);
  const [activeTab, setActiveTab] = useState<"leaderboard" | "tournament" | "challenge">("leaderboard");
  const [tournament, setTournament] = useState<TournamentRound[]>([]);
  const [language, setLanguage] = useState<"ar" | "en">("ar");
  const [tournamentStarted, setTournamentStarted] = useState(false);
  
  const [showShareModal, setShowShareModal] = useState(false);
  const [shareLink, setShareLink] = useState("");
  const [multiplayerRoom, setMultiplayerRoom] = useState<MultiplayerRoom | null>(null);
  const [rooms, setRooms] = useState<MultiplayerRoom[]>([]);
  
  // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰
  const [youtubeMusicStarted, setYoutubeMusicStarted] = useState(false);

  const { 
    playCorrect, 
    playWrong, 
    playFanfare, 
    playExciting, 
    playStart,
    playQuestionSound,
    playLoseLife,
    playVictoryMusic,
    playClick
  } = useAudio();

  const questions = language === "ar" ? allQuestionsAr[0] : allQuestionsEn[0];
  
  const generateTournament = useCallback((leaderboard: LeaderboardEntry[]): TournamentRound[] => {
    if (leaderboard.length < 4) return [];
    
    const top4 = leaderboard.slice(0, 4);
    const rounds: TournamentRound[] = [];
    let currentPlayers = top4.map(e => e.name);
    let roundNumber = 1;
    let questionSetIndex = 0;

    while (currentPlayers.length > 1) {
      const matches: Match[] = [];
      const nextPlayers: string[] = [];

      for (let i = 0; i < currentPlayers.length; i += 2) {
        if (i + 1 < currentPlayers.length) {
          const player1 = currentPlayers[i];
          const player2 = currentPlayers[i + 1];
          const p1Entry = leaderboard.find(e => e.name === player1);
          const p2Entry = leaderboard.find(e => e.name === player2);
          const p1Score = (p1Entry?.lives || 0) * 100 - (p1Entry?.time || 100);
          const p2Score = (p2Entry?.lives || 0) * 100 - (p2Entry?.time || 100);
          const winner = p1Score >= p2Score ? player1 : player2;
          
          matches.push({
            player1, player2, winner,
            player1Lives: p1Entry?.lives,
            player2Lives: p2Entry?.lives,
            player1Time: p1Entry?.time,
            player2Time: p2Entry?.time,
          });
          nextPlayers.push(winner);
        } else {
          nextPlayers.push(currentPlayers[i]);
        }
      }

      const questionSets = language === "ar" ? allQuestionsAr : allQuestionsEn;
      const questionsForRound = questionSetIndex < questionSets.length 
        ? questionSets[questionSetIndex] 
        : questionSets[0];
      
      rounds.push({ roundNumber, matches, questions: questionsForRound });
      currentPlayers = nextPlayers;
      roundNumber++;
      questionSetIndex++;
    }
    return rounds;
  }, [language]);

  // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ØªÙØ§Ø¹Ù„
  const handleInteraction = () => {
    if (!youtubeMusicStarted) {
      setYoutubeMusicStarted(true);
    }
  };

  useEffect(() => {
    const storedName = localStorage.getItem(PLAYER_KEY);
    const storedLeaderboard = localStorage.getItem(LEADERBOARD_KEY);
    const storedTournament = localStorage.getItem(TOURNAMENT_KEY);
    const storedGoat = localStorage.getItem(GOAT_KEY);
    const storedRooms = localStorage.getItem(MULTIPLAYER_ROOMS_KEY);
    const storedTournamentStarted = localStorage.getItem("gowin-tournament-started");
    
    if (storedName) {
      setPlayerName(storedName);
      setPlayerInput(storedName);
    }
    if (storedLeaderboard) setLeaderboard(JSON.parse(storedLeaderboard));
    if (storedTournament) setTournament(JSON.parse(storedTournament));
    if (storedGoat) setGoatRecord(JSON.parse(storedGoat));
    if (storedRooms) setRooms(JSON.parse(storedRooms));
    if (storedTournamentStarted) setTournamentStarted(JSON.parse(storedTournamentStarted));
  }, []);

  useEffect(() => {
    const interval = setInterval(() => {
      const storedRooms = localStorage.getItem(MULTIPLAYER_ROOMS_KEY);
      if (storedRooms) {
        const parsedRooms = JSON.parse(storedRooms);
        setRooms(parsedRooms);
        if (multiplayerRoom) {
          const currentRoom = parsedRooms.find((r: MultiplayerRoom) => r.roomId === multiplayerRoom.roomId);
          if (currentRoom) setMultiplayerRoom(currentRoom);
        }
      }
    }, 1000);
    return () => clearInterval(interval);
  }, [multiplayerRoom]);

  useEffect(() => {
    if (!playerName || status !== "playing") return;
    const timer = window.setInterval(() => setElapsed((prev) => prev + 1), 1000);
    return () => window.clearInterval(timer);
  }, [playerName, status]);

  useEffect(() => {
    if (playerName && status === "playing") {
      playQuestionSound();
    }
  }, [current, playerName, status]);

  const question = questions[current];
  const progress = useMemo(() => ((current + 1) / questions.length) * 100, [current]);

  const handleStart = () => {
    if (!playerInput.trim()) return;
    handleInteraction(); // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰
    playStart();
    localStorage.setItem(PLAYER_KEY, playerInput.trim());
    setPlayerName(playerInput.trim());
  };

  const finishGame = (nextStatus: "won" | "lost") => {
    setStatus(nextStatus);
    if (nextStatus === "won") {
      playFanfare();
      playVictoryMusic();
      const newEntry: LeaderboardEntry = {
        name: playerName,
        time: elapsed,
        lives,
        timestamp: Date.now(),
      };
      const updatedLeaderboard = [...leaderboard, newEntry]
        .sort((a, b) => {
          if (a.lives !== b.lives) return b.lives - a.lives;
          return a.time - b.time;
        })
        .slice(0, 4);
      setLeaderboard(updatedLeaderboard);
      localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(updatedLeaderboard));
    }
  };

  const startTournament = () => {
    if (leaderboard.length < 4) return;
    const tourney = generateTournament(leaderboard);
    setTournament(tourney);
    setTournamentStarted(true);
    localStorage.setItem(TOURNAMENT_KEY, JSON.stringify(tourney));
    localStorage.setItem("gowin-tournament-started", JSON.stringify(true));
    playExciting();
    
    if (tourney.length > 0) {
      const finalRound = tourney[tourney.length - 1];
      const finalWinner = finalRound.matches[0]?.winner;
      if (finalWinner) {
        const winnerEntry = leaderboard.find((entry) => entry.name === finalWinner);
        if (winnerEntry) {
          const candidate: GoatRecord = {
            name: finalWinner,
            time: winnerEntry.time,
            lives: winnerEntry.lives,
            timestamp: Date.now(),
          };
          if (isBetterRecord(candidate, goatRecord)) {
            setGoatRecord(candidate);
            localStorage.setItem(GOAT_KEY, JSON.stringify(candidate));
          }
        }
      }
    }
  };

  const handleAnswer = (option: string) => {
    if (status !== "playing") return;
    if (option === question.answer) {
      playCorrect();
      playClick();
      if (current === questions.length - 1) {
        finishGame("won");
      } else {
        setCurrent((prev) => prev + 1);
      }
    } else {
      setShake(true);
      playWrong();
      playLoseLife();
      playClick();
      navigator.vibrate?.(250);
      setLives((prev) => {
        const updated = prev - 1;
        if (updated <= 0) finishGame("lost");
        return updated;
      });
      if (current < questions.length - 1) setCurrent((prev) => prev + 1);
    }
    window.setTimeout(() => setShake(false), 700);
  };

  const hearts = Array.from({ length: TOTAL_LIVES }).map((_, index) => index < lives);

  const createRoom = (mode: "cooperative" | "versus") => {
    const roomId = Math.random().toString(36).substring(2, 9);
    const newRoom: MultiplayerRoom = {
      roomId, mode, player1: playerName, player1Ready: false, player2Ready: false,
      chat: [], currentQuestion: 0, player1Lives: TOTAL_LIVES, player2Lives: TOTAL_LIVES,
      player1Time: 0, player2Time: 0, status: "waiting",
    };
    const updatedRooms = [...rooms, newRoom];
    setRooms(updatedRooms);
    localStorage.setItem(MULTIPLAYER_ROOMS_KEY, JSON.stringify(updatedRooms));
    setMultiplayerRoom(newRoom);
    setShareLink(`${window.location.origin}?room=${roomId}`);
    setShowShareModal(true);
    playExciting();
  };

  const joinRoom = (roomId: string) => {
    const room = rooms.find(r => r.roomId === roomId);
    if (room && !room.player2) {
      const updatedRoom = { ...room, player2: playerName };
      const updatedRooms = rooms.map(r => r.roomId === roomId ? updatedRoom : r);
      setRooms(updatedRooms);
      localStorage.setItem(MULTIPLAYER_ROOMS_KEY, JSON.stringify(updatedRooms));
      setMultiplayerRoom(updatedRoom);
      playExciting();
    }
  };

  const toggleReady = () => {
    if (!multiplayerRoom) return;
    const isPlayer1 = multiplayerRoom.player1 === playerName;
    const updatedRoom = {
      ...multiplayerRoom,
      player1Ready: isPlayer1 ? !multiplayerRoom.player1Ready : multiplayerRoom.player1Ready,
      player2Ready: !isPlayer1 ? !multiplayerRoom.player2Ready : multiplayerRoom.player2Ready,
    };
    if (updatedRoom.player1Ready && updatedRoom.player2Ready && updatedRoom.status === "waiting") {
      updatedRoom.status = "playing";
      updatedRoom.startTime = Date.now();
    }
    const updatedRooms = rooms.map(r => r.roomId === multiplayerRoom.roomId ? updatedRoom : r);
    setRooms(updatedRooms);
    localStorage.setItem(MULTIPLAYER_ROOMS_KEY, JSON.stringify(updatedRooms));
    setMultiplayerRoom(updatedRoom);
  };

  const leaveRoom = () => {
    if (!multiplayerRoom) return;
    const updatedRooms = rooms.filter(r => r.roomId !== multiplayerRoom.roomId);
    setRooms(updatedRooms);
    localStorage.setItem(MULTIPLAYER_ROOMS_KEY, JSON.stringify(updatedRooms));
    setMultiplayerRoom(null);
  };

  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const roomId = params.get("room");
    if (roomId && playerName) {
      joinRoom(roomId);
      setActiveTab("challenge");
    }
  }, [playerName]);

  return (
    <div className="min-h-screen bg-animated-gradient text-white" onPointerDown={handleInteraction}>
      <div className="mx-auto flex min-h-screen max-w-6xl flex-col gap-10 px-6 py-10">
        <header className="flex flex-wrap items-center justify-between gap-6">
          <div className="relative">
            <div className="absolute inset-0 bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 blur-2xl opacity-50 animate-pulse"></div>
            <div className="relative flex items-center gap-3">
              <span className="text-5xl animate-bounce" style={{ animationDuration: '2s' }}>ğŸ†</span>
              <div>
                <h1 className="text-4xl md:text-5xl font-black bg-gradient-to-r from-yellow-200 via-yellow-300 to-orange-400 bg-clip-text text-transparent" style={{ textShadow: '0 0 40px rgba(251, 191, 36, 0.5)' }}>
                  Ø¯ÙˆØ±ÙŠ Ø£Ø¨Ø·Ø§Ù„ Gowin
                </h1>
                <p className="text-xs md:text-sm text-white/80 font-medium">âš”ï¸ Ø³Ø§Ø­Ø© Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ§Øª âš”ï¸</p>
              </div>
            </div>
          </div>
          <div className="flex items-center gap-4">
            <button onClick={() => setLanguage(language === "ar" ? "en" : "ar")} className="rounded-full bg-gradient-to-r from-cyan-400 to-blue-500 px-4 py-2 text-sm font-bold text-slate-900 shadow-lg">
              {language === "ar" ? "EN ğŸŒ" : "AR ğŸ‡¸ğŸ‡¦"}
            </button>
            <div className="text-right">
              <p className="text-sm text-white/70">{language === "ar" ? "Ø§Ù„ÙˆÙ‚Øª" : "Time"}</p>
              <p className="text-2xl font-semibold">{elapsed}s</p>
            </div>
            <div>
              <p className="text-sm text-white/70">{language === "ar" ? "Ø§Ù„Ø­ÙŠÙˆØ§Øª" : "Lives"}</p>
              <div className="flex gap-1">
                {hearts.map((filled, index) => <span key={index} className={`text-xl ${filled ? "" : "opacity-30"}`}>â¤ï¸</span>)}
              </div>
            </div>
          </div>
        </header>

        <main className="grid gap-8 lg:grid-cols-[1.1fr_0.9fr]">
          <section className={`relative rounded-3xl border border-white/15 bg-white/10 p-8 shadow-xl backdrop-blur transition-transform ${shake ? "card-shake" : ""}`}>
            <div className="absolute inset-x-8 top-6 h-2 rounded-full bg-white/10">
              <div className="h-2 rounded-full bg-gradient-to-r from-emerald-300 via-sky-300 to-indigo-300 transition-all" style={{ width: `${progress}%` }} />
            </div>
            <div className="pt-8">
              {status === "playing" ? (
                <>
                  <p className="text-sm text-white/70">{language === "ar" ? `Ø§Ù„Ø³Ø¤Ø§Ù„ ${current + 1} / ${questions.length}` : `Question ${current + 1} / ${questions.length}`}</p>
                  <div className="mt-3 flex items-start gap-4">
                    <span className="text-6xl">{question.emoji}</span>
                    <h2 className="text-2xl font-semibold leading-relaxed flex-1">{question.question}</h2>
                  </div>
                  <div className="mt-6 grid gap-3">
                    {question.options.map((option) => (
                      <button key={option} onClick={() => handleAnswer(option)} className="rounded-2xl border border-white/20 bg-white/10 px-6 py-3 text-right text-lg font-medium transition hover:-translate-y-1 hover:bg-white/20 hover:shadow-lg">
                        {option}
                      </button>
                    ))}
                  </div>
                </>
              ) : (
                <div className="rounded-2xl border border-white/20 bg-black/30 p-6 text-center">
                  <h3 className="text-2xl font-semibold mb-2">{status === "won" ? (language === "ar" ? "ğŸ‰ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ùƒ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±ÙŠ" : "ğŸ‰ Entered the league") : (language === "ar" ? "Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ğŸ˜¢" : "Game Over ğŸ˜¢")}</h3>
                  <p className="mt-1 text-white/70">{language === "ar" ? `ÙˆÙ‚ØªÙƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${elapsed}s` : `Your final time: ${elapsed}s`}</p>
                </div>
              )}
            </div>
          </section>

          <section className="flex flex-col gap-6">
            <div className="rounded-3xl border border-white/15 bg-white/10 p-6 shadow-xl backdrop-blur">
              <div className="flex gap-2 mb-4">
                {["leaderboard", "tournament", "challenge"].map((tab) => (
                  <button key={tab} onClick={() => setActiveTab(tab as any)} className={`flex-1 rounded-xl px-3 py-2 text-sm font-semibold transition ${activeTab === tab ? "bg-gradient-to-r from-yellow-400 to-orange-500 text-slate-900" : "bg-white/10 text-white/70"}`}>
                    {tab === "leaderboard" ? "ğŸ†" : tab === "tournament" ? "âš”ï¸" : "ğŸ®"} {language === "ar" ? (tab === "leaderboard" ? "Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†" : tab === "tournament" ? "Ø§Ù„Ø¯ÙˆØ±ÙŠ" : "ØªØ­Ø¯ÙŠ ØµØ¯ÙŠÙ‚") : tab.charAt(0).toUpperCase() + tab.slice(1)}
                  </button>
                ))}
              </div>
              
              {activeTab === "leaderboard" ? (
                <div className="space-y-3">
                  {goatRecord && (
                    <div className="rounded-2xl bg-gradient-to-r from-yellow-300 via-orange-400 to-red-500 p-[2px]">
                      <div className="rounded-2xl bg-slate-900/90 p-4 text-center">
                        <p className="text-sm text-yellow-200 font-semibold">ğŸ‘‘ THE GOAT</p>
                        <p className="text-xl font-black text-white">{goatRecord.name}</p>
                        <p className="text-xs text-white/70">â¤ï¸ {goatRecord.lives} â€¢ {goatRecord.time}s</p>
                      </div>
                    </div>
                  )}
                  {leaderboard.map((entry, index) => {
                    const rankInfo = getRankTitle(index + 1);
                    return (
                      <div key={index} className={`rounded-xl bg-gradient-to-r ${rankInfo.color} p-[2px]`}>
                        <div className="rounded-xl bg-slate-900/90 p-3 flex justify-between items-center">
                          <div className="flex items-center gap-2">
                            <span className="text-2xl">{rankInfo.emoji}</span>
                            <div><p className="font-semibold">{entry.name}</p><p className="text-xs text-white/60">{rankInfo.title}</p></div>
                          </div>
                          <div className="text-right"><p className="text-sm font-semibold">{entry.time}s</p><p className="text-xs text-white/60">â¤ï¸ {entry.lives}</p></div>
                        </div>
                      </div>
                    );
                  })}
                  <button onClick={() => setPlayerName("")} className="mt-4 w-full rounded-full border border-white/30 px-4 py-2 text-sm transition hover:bg-white/20">
                    {language === "ar" ? "ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…" : "Change Name"}
                  </button>
                </div>
              ) : activeTab === "tournament" ? (
                <div className="space-y-4">
                   {!tournamentStarted && leaderboard.length >= 4 && (
                    <button onClick={startTournament} className="w-full rounded-xl bg-gradient-to-r from-green-400 to-emerald-500 p-4 text-slate-900 font-bold shadow-lg transition hover:scale-105">
                      ğŸš€ {language === "ar" ? "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¢Ù†!" : "Start Tournament Now!"}
                    </button>
                  )}
                  {tournament.map((round) => (
                    <div key={round.roundNumber} className="rounded-xl bg-white/5 p-4 border border-white/10">
                      <h3 className="font-bold text-yellow-300 mb-2">{language === "ar" ? `Ø§Ù„Ù…Ø±Ø­Ù„Ø© ${round.roundNumber}` : `Round ${round.roundNumber}`}</h3>
                      {round.matches.map((match, idx) => (
                        <div key={idx} className="bg-white/10 p-2 rounded mb-2 text-xs flex justify-between items-center">
                          <span className={match.winner === match.player1 ? "text-green-300 font-bold" : ""}>{match.player1}</span>
                          <span>âš”ï¸</span>
                          <span className={match.winner === match.player2 ? "text-green-300 font-bold" : ""}>{match.player2}</span>
                        </div>
                      ))}
                    </div>
                  ))}
                </div>
              ) : (
                <div className="space-y-3">
                  {!multiplayerRoom ? (
                    <button onClick={() => createRoom("versus")} className="w-full rounded-xl bg-gradient-to-r from-red-400 to-pink-500 p-4 text-slate-900 font-bold shadow-lg">
                      âš”ï¸ {language === "ar" ? "Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© ØªØ­Ø¯ÙŠ" : "Create Challenge"}
                    </button>
                  ) : (
                    <div className="bg-white/10 p-4 rounded-xl">
                       <p className="text-sm mb-4">ID: {multiplayerRoom.roomId}</p>
                       <button onClick={toggleReady} className="w-full bg-yellow-500 text-slate-900 p-2 rounded-lg font-bold">
                         {multiplayerRoom.player1Ready ? "âœ… Ready" : "ğŸš€ Ready?"}
                       </button>
                       <button onClick={leaveRoom} className="w-full mt-2 text-red-400 text-xs">Leave</button>
                    </div>
                  )}
                </div>
              )}
            </div>
          </section>
        </main>

        <footer className="text-center mt-10">
          <p className="text-white/60 text-sm">
            {language === "ar" ? "ØªØ§Ø¨Ø¹Ù†Ø§ Ø¹Ù„Ù‰" : "Follow us"} <a href="https://instagram.com/_itlulp" target="_blank" className="text-pink-400 font-semibold">@_itlulp ğŸ“±</a>
          </p>
        </footer>
      </div>

      {!playerName && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/90 backdrop-blur-sm p-6">
          <div className="w-full max-w-lg rounded-3xl border border-white/20 bg-slate-900 p-8 shadow-2xl text-center">
            <h1 className="text-4xl font-black bg-gradient-to-r from-yellow-200 to-orange-400 bg-clip-text text-transparent mb-6">Ø¯ÙˆØ±ÙŠ Ø£Ø¨Ø·Ø§Ù„ Gowin</h1>
            <input value={playerInput} onChange={(e) => setPlayerInput(e.target.value)} onKeyDown={(e) => e.key === "Enter" && handleStart()} placeholder={language === "ar" ? "Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§" : "Enter your name"} className="w-full rounded-2xl bg-white/10 p-4 text-center border border-white/20 focus:outline-none mb-4" />
            <button onClick={handleStart} className="w-full rounded-2xl bg-gradient-to-r from-yellow-400 to-orange-500 p-4 font-bold text-slate-900 shadow-xl">ğŸš€ {language === "ar" ? "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨" : "Start Playing"}</button>
          </div>
        </div>
      )}

      {showShareModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur p-6">
          <div className="bg-slate-900 p-8 rounded-3xl border border-white/20 text-center max-w-sm w-full">
            <h2 className="text-xl font-bold mb-4">ğŸ”— Ø´Ø§Ø±Ùƒ Ø§Ù„Ø±Ø§Ø¨Ø·</h2>
            <div className="bg-white/10 p-3 rounded mb-4 text-xs break-all">{shareLink}</div>
            <button onClick={() => {navigator.clipboard.writeText(shareLink); setShowShareModal(false)}} className="w-full bg-cyan-500 text-slate-900 p-3 rounded-xl font-bold">Ù†Ø³Ø® ÙˆØ¥ØºÙ„Ø§Ù‚</button>
          </div>
        </div>
      )}

      {/* Ù…Ø´ØºÙ„ ÙŠÙˆØªÙŠÙˆØ¨ Ø§Ù„Ù…Ø®ÙÙŠ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© */}
      {youtubeMusicStarted && (
        <div style={{ position: 'fixed', top: -100, left: -100, opacity: 0, pointerEvents: 'none' }}>
          <iframe
            width="100"
            height="100"
            src="https://www.youtube.com/embed/jfKfPfyJRdk?autoplay=1&loop=1&playlist=jfKfPfyJRdk&controls=0&disablekb=1"
            title="Background Music"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          ></iframe>
        </div>
      )}
    </div>
  );
}
