import { useEffect, useMemo, useRef, useState, useCallback } from "react";

type Question = {
  emoji: string;
  question: string;
  options: string[];
  answer: string;
};

type LeaderboardEntry = {
  name: string;
  time: number;
  lives: number;
  timestamp: number;
};

type GoatRecord = {
  name: string;
  time: number;
  lives: number;
  timestamp: number;
};

const isBetterRecord = (candidate: GoatRecord, current: GoatRecord | null) => {
  if (!current) return true;
  if (candidate.lives !== current.lives) return candidate.lives > current.lives;
  return candidate.time < current.time;
};

type Match = {
  player1: string;
  player2: string;
  winner?: string;
  player1Lives?: number;
  player2Lives?: number;
  player1Time?: number;
  player2Time?: number;
};

type TournamentRound = {
  roundNumber: number;
  matches: Match[];
  questions: Question[];
};

type ChatMessage = {
  sender: string;
  message: string;
  timestamp: number;
};

type MultiplayerRoom = {
  roomId: string;
  mode: "cooperative" | "versus";
  player1: string;
  player2?: string;
  player1Ready: boolean;
  player2Ready: boolean;
  chat: ChatMessage[];
  currentQuestion: number;
  player1Lives: number;
  player2Lives: number;
  player1Time: number;
  player2Time: number;
  startTime?: number;
  status: "waiting" | "playing" | "finished";
  winner?: string;
};

const allQuestionsAr: Question[][] = [
  [
    { emoji: "ğŸŒ", question: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© ÙØ±Ù†Ø³Ø§ØŸ", options: ["Ø¨Ø§Ø±ÙŠØ³", "Ù…Ø¯Ø±ÙŠØ¯", "Ø±ÙˆÙ…Ø§", "Ø¨Ø±Ù„ÙŠÙ†"], answer: "Ø¨Ø§Ø±ÙŠØ³" },
    { emoji: "ğŸ§®", question: "ÙƒÙ… Ø§Ù„Ù†Ø§ØªØ¬ØŸ 12 Ã— 8", options: ["92", "96", "88", "108"], answer: "96" },
    { emoji: "ğŸª", question: "Ø£ÙƒØ¨Ø± ÙƒÙˆÙƒØ¨ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø´Ù…Ø³ÙŠØ©ØŸ", options: ["Ø§Ù„Ø£Ø±Ø¶", "Ø§Ù„Ù…Ø´ØªØ±ÙŠ", "Ø§Ù„Ù…Ø±ÙŠØ®", "Ø²Ø­Ù„"], answer: "Ø§Ù„Ù…Ø´ØªØ±ÙŠ" },
    { emoji: "ğŸ’»", question: "Ù…Ø¤Ø³Ø³ Ø´Ø±ÙƒØ© Ù…Ø§ÙŠÙƒØ±ÙˆØ³ÙˆÙØªØŸ", options: ["Ø³ØªÙŠÙ Ø¬ÙˆØ¨Ø²", "Ø¥ÙŠÙ„ÙˆÙ† Ù…Ø§Ø³Ùƒ", "Ø¨ÙŠÙ„ ØºÙŠØªØ³", "Ù…Ø§Ø±Ùƒ Ø²ÙˆÙƒØ±Ø¨ÙŠØ±Øº"], answer: "Ø¨ÙŠÙ„ ØºÙŠØªØ³" },
  ],
];

const allQuestionsEn: Question[][] = [
  [
    { emoji: "ğŸŒ", question: "What is the capital of France?", options: ["Paris", "Madrid", "Rome", "Berlin"], answer: "Paris" },
    { emoji: "ğŸ§®", question: "What is 12 Ã— 8?", options: ["92", "96", "88", "108"], answer: "96" },
    { emoji: "ğŸª", question: "The largest planet in our solar system?", options: ["Earth", "Jupiter", "Mars", "Saturn"], answer: "Jupiter" },
    { emoji: "ğŸ’»", question: "Founder of Microsoft?", options: ["Steve Jobs", "Elon Musk", "Bill Gates", "Mark Zuckerberg"], answer: "Bill Gates" },
  ],
];

const TOTAL_LIVES = 5;
const PLAYER_KEY = "player-name";
const LEADERBOARD_KEY = "gowin-leaderboard";
const TOURNAMENT_KEY = "gowin-tournament";
const GOAT_KEY = "gowin-goat-record";
const MULTIPLAYER_ROOMS_KEY = "gowin-multiplayer-rooms";

const getRankTitle = (rank: number): { title: string; emoji: string; color: string } => {
  if (rank === 1) return { title: "Ø£Ø³Ø·ÙˆØ±Ø©", emoji: "ğŸ‘‘", color: "from-yellow-400 to-orange-500" };
  if (rank === 2) return { title: "Ø¹Ø¨Ù‚Ø±ÙŠ", emoji: "ğŸ§ ", color: "from-purple-400 to-pink-500" };
  if (rank === 3) return { title: "Ø°ÙŠØ¨", emoji: "ğŸº", color: "from-blue-400 to-cyan-500" };
  return { title: "Ù…Ø¨ØªØ¯Ø¦", emoji: "ğŸ”¥", color: "from-gray-400 to-slate-500" };
};

const useAudio = () => {
  const playSound = (frequency: number, duration: number = 0.5, volume: number = 0.5) => {
    try {
      const ctx = new AudioContext();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = "sine";
      osc.frequency.value = frequency;
      gain.gain.setValueAtTime(0, ctx.currentTime);
      gain.gain.linearRampToValueAtTime(volume, ctx.currentTime + 0.05);
      gain.gain.linearRampToValueAtTime(0, ctx.currentTime + duration);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime + duration);
      setTimeout(() => ctx.close(), (duration + 0.1) * 1000);
    } catch (e) {}
  };

  return {
    playCorrect: () => playSound(600, 0.2),
    playWrong: () => playSound(200, 0.4),
    playFanfare: () => playSound(800, 0.5),
    playStart: () => playSound(500, 0.3),
    playQuestionSound: () => {},
    playLoseLife: () => playSound(150, 0.3),
    playVictoryMusic: () => {},
    playExciting: () => playSound(700, 0.3),
    playClick: () => playSound(900, 0.05)
  };
};

export const App = () => {
  const [playerName, setPlayerName] = useState("");
  const [playerInput, setPlayerInput] = useState("");
  const [current, setCurrent] = useState(0);
  const [lives, setLives] = useState(TOTAL_LIVES);
  const [shake, setShake] = useState(false);
  const [elapsed, setElapsed] = useState(0);
  const [status, setStatus] = useState<"playing" | "won" | "lost">("playing");
  const [leaderboard, setLeaderboard] = useState<LeaderboardEntry[]>([]);
  const [goatRecord, setGoatRecord] = useState<GoatRecord | null>(null);
  const [activeTab, setActiveTab] = useState<"leaderboard" | "tournament" | "challenge">("leaderboard");
  const [tournament, setTournament] = useState<TournamentRound[]>([]);
  const [language, setLanguage] = useState<"ar" | "en">("ar");
  const [tournamentStarted, setTournamentStarted] = useState(false);
  const [showShareModal, setShowShareModal] = useState(false);
  const [shareLink, setShareLink] = useState("");
  const [multiplayerRoom, setMultiplayerRoom] = useState<MultiplayerRoom | null>(null);
  const [rooms, setRooms] = useState<MultiplayerRoom[]>([]);
  
  // Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ©
  const [isMusicStarted, setIsMusicStarted] = useState(false);

  const { playCorrect, playWrong, playFanfare, playStart, playLoseLife, playClick } = useAudio();

  const questions = language === "ar" ? allQuestionsAr[0] : allQuestionsEn[0];

  const handleStart = () => {
    if (!playerInput.trim()) return;
    setIsMusicStarted(true); // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
    playStart();
    localStorage.setItem(PLAYER_KEY, playerInput.trim());
    setPlayerName(playerInput.trim());
  };

  const handleAnswer = (option: string) => {
    if (status !== "playing") return;
    if (option === questions[current].answer) {
      playCorrect();
      if (current === questions.length - 1) {
        setStatus("won");
        playFanfare();
      } else {
        setCurrent(prev => prev + 1);
      }
    } else {
      setShake(true);
      playWrong();
      playLoseLife();
      setLives(prev => {
        if (prev - 1 <= 0) setStatus("lost");
        return prev - 1;
      });
      setTimeout(() => setShake(false), 500);
    }
  };

  const progress = ((current + 1) / questions.length) * 100;

  return (
    <div className="min-h-screen bg-animated-gradient text-white font-sans selection:bg-cyan-500/30">
      <div className="mx-auto flex min-h-screen max-w-6xl flex-col gap-10 px-6 py-10">
        
        {/* Header Section */}
        <header className="flex flex-wrap items-center justify-between gap-6">
          <div className="relative">
            <h1 className="text-4xl md:text-5xl font-black bg-gradient-to-r from-yellow-200 to-orange-400 bg-clip-text text-transparent">
              Ø¯ÙˆØ±ÙŠ Ø£Ø¨Ø·Ø§Ù„ Gowin
            </h1>
          </div>
          <div className="flex items-center gap-6">
            <div className="text-right">
              <p className="text-sm text-white/70">Ø§Ù„ÙˆÙ‚Øª</p>
              <p className="text-2xl font-semibold">{elapsed}s</p>
            </div>
            <div>
              <p className="text-sm text-white/70">Ø§Ù„Ø­ÙŠÙˆØ§Øª</p>
              <div className="flex gap-1">
                {Array.from({ length: TOTAL_LIVES }).map((_, i) => (
                  <span key={i} className={i < lives ? "text-xl" : "text-xl opacity-20"}>â¤ï¸</span>
                ))}
              </div>
            </div>
          </div>
        </header>

        {/* Main Game Section */}
        <main className="grid gap-8 lg:grid-cols-[1.1fr_0.9fr]">
          <section className={`relative rounded-3xl border border-white/15 bg-white/10 p-8 shadow-xl backdrop-blur ${shake ? "card-shake" : ""}`}>
            {status === "playing" ? (
              <>
                <div className="mb-6 h-2 w-full rounded-full bg-white/10">
                  <div className="h-full rounded-full bg-gradient-to-r from-cyan-400 to-blue-500 transition-all duration-500" style={{ width: `${progress}%` }} />
                </div>
                <h2 className="text-3xl font-bold mb-8">{questions[current].emoji} {questions[current].question}</h2>
                <div className="grid gap-4">
                  {questions[current].options.map(opt => (
                    <button key={opt} onClick={() => handleAnswer(opt)} className="w-full rounded-2xl border border-white/10 bg-white/5 p-4 text-right text-lg transition hover:bg-white/20">
                      {opt}
                    </button>
                  ))}
                </div>
              </>
            ) : (
              <div className="py-20 text-center">
                <h2 className="text-4xl font-black mb-4">{status === "won" ? "ğŸ† Ù…Ø¨Ø±ÙˆÙƒ Ø§Ù„ÙÙˆØ²!" : "ğŸ’€ Ø­Ø¸ Ø£ÙˆÙØ±.."}</h2>
                <button onClick={() => window.location.reload()} className="rounded-xl bg-white px-8 py-3 font-bold text-slate-900">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
              </div>
            )}
          </section>

          {/* Leaderboard Section */}
          <section className="rounded-3xl border border-white/15 bg-white/10 p-6 shadow-xl backdrop-blur">
             <h3 className="text-xl font-bold mb-4">ğŸ† Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ†</h3>
             <div className="space-y-3 opacity-50 text-center py-10">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØµØ¯Ø±ÙŠÙ† Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¹Ù†Ø¯ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø©</div>
          </section>
        </main>
      </div>

      {/* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ - ØªØ¸Ù‡Ø± Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ø³Ù… */}
      {!playerName && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/90 backdrop-blur-sm p-6">
          <div className="w-full max-w-lg rounded-3xl border border-white/20 bg-slate-900 p-8 shadow-2xl text-center">
            <h2 className="text-3xl font-black text-white mb-6">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠ</h2>
            <input 
              value={playerInput} 
              onChange={(e) => setPlayerInput(e.target.value)} 
              placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù„Ù„Ù…Ù†Ø§ÙØ³Ø©..." 
              className="w-full rounded-2xl bg-white/10 p-4 text-center text-white border border-white/20 focus:outline-none mb-6"
            />
            <button onClick={handleStart} className="w-full rounded-2xl bg-gradient-to-r from-yellow-400 to-orange-500 p-4 font-bold text-slate-900 text-xl shadow-xl hover:scale-105 transition-transform">
              ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨
            </button>
          </div>
        </div>
      )}

      {/* Ù…Ø´ØºÙ„ ÙŠÙˆØªÙŠÙˆØ¨ Ø§Ù„Ù…Ø®ÙÙŠ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© */}
      {isMusicStarted && (
        <div style={{ position: 'absolute', top: '-1000px', left: '-1000px', pointerEvents: 'none' }}>
          <iframe
            width="0"
            height="0"
            src="https://www.youtube.com/embed/jfKfPfyJRdk?autoplay=1&loop=1&playlist=jfKfPfyJRdk&controls=0"
            title="Background Music"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          ></iframe>
        </div>
      )}
    </div>
  );
};

export default App;
